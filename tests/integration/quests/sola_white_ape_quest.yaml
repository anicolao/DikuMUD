# Integration test for Sola's White Ape Quest in Thark Territory
#
# This test validates the quest system by testing Sola's quest where
# the player must bring her a white ape tooth as proof of defeating
# one of the beasts threatening the Tharks.
#
# Quest Details:
# - Quest Giver: Sola (vnum 4051) in The Council Hall (room 4002)
# - Quest Type: QUEST_RETRIEVAL (type 62)
# - Item Required: White Ape Tooth (vnum 4091)
# - Reward: 500 experience + Tars Tarkas's Practice Sword (vnum 4090)
#
# Expected Behavior:
# - Player can ask Sola about "quest", "help", or "task" to get quest assigned
# - Player receives quest affect with duration 96 MUD hours
# - Player can give white ape tooth to Sola to complete quest
# - Player receives experience reward and practice sword
# - Quest affect is removed after completion

test:
  id: sola_white_ape_quest
  description: "Test Sola's white ape tooth quest in Thark Territory"
  author: Integration Test Framework
  created: 2025-10-10
  tags: [quest, thark_territory, retrieval, sola]

setup:
  character:
    name: QuestTester
    password: test
    level: 22  # Level 22 to use 'load' command for testing
    class: warrior
  start_room: 4002  # The Council Hall where Sola is located
  gold: 100
  # Note: The character needs level 22 to use god commands (load obj)
  # to give themselves the white ape tooth for testing purposes.

steps:
  # Step 1: Verify we're in the right room with Sola
  - action: look
    description: "Look around to confirm we're in The Council Hall"
    expected:
      - pattern: "Council Hall|council"
        message: "Should be in The Council Hall"
      - pattern: "Sola"
        message: "Sola should be present in the room"

  # Step 2: Ask Sola about the quest to get it assigned
  # The quest system responds to 'ask <npc> quest' or similar
  - action: command
    description: "Ask Sola about a quest"
    command: "ask sola quest"
    expected:
      - pattern: "White apes|white apes|apes|tooth"
        message: "Sola should mention white apes and the quest"
      - pattern: "ancient ruins|defeat|prove"
        message: "Sola should describe the quest objective"
    fail_on:
      - pattern: "You already have a task|already have"
        message: "Should not already have this quest assigned"

  # Step 3: Check score or quest status to verify quest was assigned
  # (This is optional since we can't easily verify quest affects via telnet)
  - action: command
    description: "Check score to see if quest is active (optional verification)"
    command: "score"
    expected:
      - pattern: "."
        message: "Score command should work"
        optional: true

  # Step 4: Load the white ape tooth for testing (god command)
  # NOTE: This requires the test character to be created with the item,
  # which is not yet implemented in create_test_player.
  # For now, we'll use a god command to create the tooth.
  - action: command
    description: "Load the white ape tooth for testing (god command)"
    command: "load obj 4091"
    expected:
      - pattern: "Ok"
        message: "Should load the white ape tooth"
        optional: true

  # Step 5: Look to see if the tooth is there
  - action: look
    description: "Look to see if the tooth is on the ground"
    expected:
      - pattern: "tooth"
        message: "Tooth should be visible in the room"

  # Step 6: Pick up the white ape tooth from the room
  - action: command
    description: "Pick up the white ape tooth"
    command: "get tooth"
    expected:
      - pattern: "You get|you get|take"
        message: "Should successfully pick up the tooth"

  # Step 7: Check inventory to confirm we have the tooth
  - action: inventory
    description: "Verify white ape tooth is in inventory"
    expected:
      - pattern: "tooth|Tooth"
        message: "White ape tooth should be in inventory"

  # Step 8: Give the white ape tooth to Sola to complete the quest
  - action: command
    description: "Give the white ape tooth to Sola to complete the quest"
    command: "give tooth sola"
    expected:
      - pattern: "relief|gratitude|proven|reward|sword"
        message: "Sola should acknowledge the quest completion and give reward"
      - pattern: "practice sword|Practice Sword"
        message: "Should receive Tars Tarkas's Practice Sword"
    fail_on:
      - pattern: "don't want that|not interested"
        message: "Sola should accept the white ape tooth for the quest"

  # Step 9: Verify we received the experience reward
  # We can't directly check experience, but the completion message should confirm
  - action: command
    description: "Check score to see experience gained"
    command: "score"
    expected:
      - pattern: "."
        message: "Score command should work"

  # Step 10: Verify the practice sword is in our inventory
  - action: inventory
    description: "Verify practice sword is now in inventory"
    expected:
      - pattern: "practice sword|Practice Sword|sword"
        message: "Tars Tarkas's Practice Sword should be in inventory"

  # Step 11: Try to get the quest again - should be told we already completed it
  # or that we already have a task (depending on implementation)
  - action: command
    description: "Try asking Sola for the quest again"
    command: "ask sola quest"
    expected:
      - pattern: "already|again|completed|You already have"
        message: "Sola should not give the quest again immediately"
        optional: true

result:
  should_pass: true
  description: "Test passes when player can get quest from Sola, give her the tooth, and receive rewards"
  notes: |
    This test validates the complete quest flow for Sola's white ape quest:
    
    1. Player can interact with Sola to get quest assigned
    2. Quest affect is properly added to the character
    3. Player can give the required item (white ape tooth) to Sola
    4. Quest completion is detected when item is given
    5. Rewards are granted (500 exp, practice sword)
    6. Quest affect is removed after completion
    
    Current Limitation:
    The test currently uses a god command (load obj) to give the character
    the white ape tooth. In a real scenario, the player would need to:
    - Navigate to the ancient ruins (rooms 4030+)
    - Fight and defeat a white ape (mob 4083)
    - Obtain the tooth that drops from the ape
    
    Future Enhancement:
    Modify create_test_player to support --items flag to pre-load items:
    create_test_player -d test_lib QuestTester test 4002 --items 4091
