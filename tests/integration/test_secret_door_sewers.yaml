test:
  id: test_secret_door_sewers
  description: Verify secret door in sewers (room 3165) is hidden but discoverable via floor examination
  author: Copilot
  created: '2025-10-16'
  tags: ['secret_door', 'sewers', 'room_3165']

setup:
  character:
    name: TestWizard
    password: test
    class: warrior
    level: 34
  start_room: 3165
  gold: 0

steps:
  # Test 0: Make sure we can see (give ourselves infravision)
  - action: command
    command: cast 'infravision'
    description: Cast infravision to see in the dark sewers
    expected:
      - pattern: '.'

  # Test 1: Verify the secret door doesn't appear in obvious exits
  - action: command
    command: look
    description: Check that room shows no obvious exits (secret door is hidden)
    expected:
      - pattern: 'Ancient Eastern Passage'
      - pattern: 'Obvious exits:'
      - pattern: 'West -'
      - not_pattern: 'South -'
    unexpected:
      - pattern: 'South - Secret Lower Level Access'

  # Test 2: Verify floor can be examined and provides clues
  - action: command
    command: look floor
    description: Examine the floor to discover clues about secret door
    expected:
      - pattern: 'floor tiles form a distinctive rectangular pattern'
      - pattern: 'slightly raised'
      - pattern: 'scrape marks'
      - pattern: 'breeze emanates from the cracks'

  # Test 3: Verify tiles keyword also works
  - action: command
    command: look tiles
    description: Examine tiles should also show the secret door clue
    expected:
      - pattern: 'floor tiles form a distinctive rectangular pattern'

  # Test 4: Verify pattern keyword also works
  - action: command
    command: look pattern
    description: Examine pattern should also show the secret door clue
    expected:
      - pattern: 'floor tiles form a distinctive rectangular pattern'

  # Test 5: Try to open the secret door using keywords
  - action: command
    command: open hatch
    description: Try to open the hatch (secret door) by keyword
    expected:
      - pattern: 'Ok\\.'

  # Test 6: Verify door now shows as open
  - action: command
    command: look
    description: After opening, the door should show in obvious exits
    expected:
      - pattern: 'Obvious exits:'
      - pattern: 'South - Secret Lower Level Access'

  # Test 7: Look south to see the description
  - action: command
    command: look south
    description: Look at the now-open door to the south
    expected:
      - pattern: 'The passage continues south, partially blocked by debris'
      - pattern: 'The hatch is open'

  # Test 8: Go through the door
  - action: command
    command: south
    description: Go through the secret door to verify it works
    expected:
      - pattern: 'Secret Lower Level Access'

  # Test 9: Close the door from the other side
  - action: command
    command: close hatch
    description: Close the secret door from inside
    expected:
      - pattern: 'Ok\\.'

  # Test 10: Verify door is closed and doesn't show in obvious exits
  - action: command
    command: look
    description: Check that obvious exits doesn't show the door when closed
    expected:
      - pattern: 'Secret Lower Level Access'
      - pattern: 'Obvious exits:'
      - pattern: 'South -'
    unexpected:
      - pattern: 'North - Ancient Eastern Passage'
